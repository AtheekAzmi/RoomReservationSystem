<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Rooms — Hotel System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <style>
        :root { --primary:#1a3c5e; --accent:#e8a020; --sidebar:250px; }
        * { box-sizing:border-box; }
        body {
            background:#f0f4f8;
            font-family:'Segoe UI',sans-serif;
            margin:0; padding:0;
        }

        /* Sidebar */
        .sidebar {
            position:fixed; top:0; left:0;
            width:var(--sidebar); height:100vh;
            background:var(--primary); z-index:1000;
            overflow-y:auto; display:flex;
            flex-direction:column;
        }
        .sidebar .nav-link {
            color:rgba(255,255,255,.75);
            padding:.65rem 1rem;
            display:flex; align-items:center;
            gap:.75rem; font-size:.9rem;
            border-left:3px solid transparent;
            transition:all .2s; text-decoration:none;
        }
        .sidebar .nav-link:hover,
        .sidebar .nav-link.active {
            background:rgba(255,255,255,.12);
            color:#fff; border-left-color:var(--accent);
        }

        /* Layout */
        .main-content {
            margin-left:var(--sidebar);
            min-height:100vh;
            display:flex; flex-direction:column;
        }
        .topbar {
            background:#fff; padding:.875rem 1.5rem;
            border-bottom:1px solid #e0e0e0;
            display:flex; align-items:center;
            justify-content:space-between;
            position:sticky; top:0; z-index:999;
            flex-shrink:0;
        }
        .content-area { padding:1.5rem; flex:1; }

        /* Cards */
        .card-box {
            background:#fff; border-radius:12px;
            padding:1.5rem;
            box-shadow:0 2px 8px rgba(0,0,0,.06);
        }
        .stat-box {
            background:#fff; border-radius:12px;
            padding:1.1rem 1.25rem;
            display:flex; align-items:center;
            gap:1rem; height:100%;
            box-shadow:0 2px 8px rgba(0,0,0,.06);
        }
        .stat-ic {
            width:48px; height:48px; border-radius:10px;
            display:flex; align-items:center;
            justify-content:center;
            font-size:1.3rem; flex-shrink:0;
        }

        /* Room Grid Card */
        .room-grid-card {
            background:#fff; border-radius:12px;
            border:2px solid #e0e0e0;
            padding:1.25rem; transition:all .2s;
            position:relative; overflow:hidden;
            cursor:default;
        }
        .room-grid-card:hover {
            border-color:#2e6da4;
            box-shadow:0 4px 16px rgba(26,60,94,.12);
            transform:translateY(-2px);
        }
        .room-number-badge {
            font-size:1.4rem; font-weight:700;
            color:var(--primary); line-height:1;
        }
        .room-type-tag {
            font-size:.75rem; font-weight:600;
            padding:.2rem .65rem; border-radius:20px;
            background:#e3f2fd; color:#1565c0;
        }
        .room-type-tag.Double  { background:#e8f5e9; color:#2e7d32; }
        .room-type-tag.Deluxe  { background:#fff3e0; color:#e65100; }
        .room-type-tag.Suite   { background:#f3e5f5; color:#6a1b9a; }
        .status-dot {
            width:10px; height:10px; border-radius:50%;
            display:inline-block; margin-right:.4rem;
        }

        /* Table */
        .table thead th {
            background:#f8fafc; color:#555;
            font-size:.78rem; font-weight:600;
            text-transform:uppercase; letter-spacing:.5px;
            border-bottom:2px solid #e0e0e0;
            white-space:nowrap;
        }
        .table tbody td {
            vertical-align:middle; font-size:.875rem;
            border-color:#f0f0f0;
        }
        .table tbody tr:hover { background:#f8faff; }

        /* Modal */
        .modal-header {
            background:var(--primary); color:#fff;
            border-radius:12px 12px 0 0;
        }
        .modal-header .btn-close { filter:invert(1); }
        .modal-content { border-radius:12px; border:none; }

        /* Buttons */
        .btn-hotel {
            background:linear-gradient(135deg,#1a3c5e,#2e6da4);
            color:#fff; border:none;
            border-radius:8px; font-weight:500;
        }
        .btn-hotel:hover {
            background:linear-gradient(135deg,#152f4a,#245a8a);
            color:#fff;
        }
        .btn-hotel:disabled { opacity:.65; }
        .form-control:focus, .form-select:focus {
            border-color:#2e6da4;
            box-shadow:0 0 0 .2rem rgba(46,109,164,.2);
        }

        /* View toggle */
        .view-toggle .btn {
            border-radius:8px; font-size:.85rem;
        }
        .view-toggle .btn.active {
            background:var(--primary); color:#fff;
            border-color:var(--primary);
        }

        /* Room type image banner */
        .room-type-banner {
            height:120px;
            margin:-1.25rem -1.25rem 1rem;
            display:flex; flex-direction:column;
            align-items:center; justify-content:center;
            position:relative;
        }
        .room-type-banner .rtb-icon {
            font-size:2.8rem; opacity:.85; line-height:1;
            position:relative; z-index:2;
        }
        .room-type-banner .rtb-label {
            font-size:.7rem; font-weight:700;
            letter-spacing:.8px; text-transform:uppercase;
            margin-top:.45rem; opacity:.9;
            position:relative; z-index:2;
        }
        /* Dark gradient overlay for photo banners */
        .room-type-banner .rtb-overlay {
            position:absolute; inset:0; z-index:1;
            background:linear-gradient(to bottom,
                rgba(0,0,0,.08) 0%, rgba(0,0,0,.48) 100%);
        }
        /* Status ribbon in top-right of banner */
        .room-type-banner .rtb-status {
            position:absolute; top:8px; right:10px;
            font-size:.68rem; font-weight:700;
            padding:.2rem .55rem; border-radius:20px;
            letter-spacing:.4px; text-transform:uppercase;
            background:rgba(255,255,255,.85);
            z-index:2;
        }

        /* Available room card */
        .avail-card {
            border:2px solid #dee2e6; border-radius:8px;
            overflow:hidden; cursor:pointer; transition:all .2s;
        }
        .avail-card:hover    { border-color:#2e6da4; box-shadow:0 2px 8px rgba(46,109,164,.15); }
        .avail-card.selected { border-color:var(--primary); background:#e8f0fe; }
        .avail-card .avail-banner {
            height:70px; display:flex;
            align-items:center; justify-content:center;
            font-size:1.6rem;
        }
        .avail-card .avail-body { padding:.6rem .75rem; }

        /* Table room-image thumb */
        .room-thumb {
            width:36px; height:36px; border-radius:8px;
            display:inline-flex; align-items:center;
            justify-content:center; font-size:1.1rem;
            flex-shrink:0;
        }

        @media(max-width:768px){
            .sidebar      { transform:translateX(-100%); }
            .main-content { margin-left:0; }
        }
    </style>
</head>
<body>

<!-- SIDEBAR -->
<div class="sidebar" id="sidebar"></div>

<!-- MAIN -->
<div class="main-content">

    <!-- Topbar -->
    <div class="topbar">
        <div class="d-flex align-items-center gap-3">
            <a href="dashboard.html"
               class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-arrow-left me-1"></i>Dashboard
            </a>
            <h5 class="mb-0"
                style="color:var(--primary);font-weight:600">
                <i class="bi bi-door-open me-2"></i>Rooms
            </h5>
        </div>
        <div class="d-flex align-items-center gap-2">
      <span class="text-muted" style="font-size:.85rem">
        <i class="bi bi-person-circle me-1"></i>
        <span id="topbarUser"></span>
      </span>
            <span class="badge bg-secondary" id="topbarRole"></span>
        </div>
    </div>

    <!-- Content -->
    <div class="content-area">

        <!-- Stats -->
        <div class="row g-3 mb-4">
            <div class="col-6 col-xl-3">
                <div class="stat-box">
                    <div class="stat-ic"
                         style="background:#e3f2fd;color:#1565c0">
                        <i class="bi bi-building"></i>
                    </div>
                    <div>
                        <div class="fs-4 fw-bold" id="st-total">—</div>
                        <div class="text-muted" style="font-size:.78rem">
                            Total Rooms</div>
                    </div>
                </div>
            </div>
            <div class="col-6 col-xl-3">
                <div class="stat-box">
                    <div class="stat-ic"
                         style="background:#e8f5e9;color:#2e7d32">
                        <i class="bi bi-check-circle"></i>
                    </div>
                    <div>
                        <div class="fs-4 fw-bold" id="st-available">—</div>
                        <div class="text-muted" style="font-size:.78rem">
                            Available</div>
                    </div>
                </div>
            </div>
            <div class="col-6 col-xl-3">
                <div class="stat-box">
                    <div class="stat-ic"
                         style="background:#fff3e0;color:#e65100">
                        <i class="bi bi-person-fill"></i>
                    </div>
                    <div>
                        <div class="fs-4 fw-bold" id="st-occupied">—</div>
                        <div class="text-muted" style="font-size:.78rem">
                            Occupied</div>
                    </div>
                </div>
            </div>
            <div class="col-6 col-xl-3">
                <div class="stat-box">
                    <div class="stat-ic"
                         style="background:#fce4ec;color:#c62828">
                        <i class="bi bi-tools"></i>
                    </div>
                    <div>
                        <div class="fs-4 fw-bold" id="st-maintenance">—</div>
                        <div class="text-muted" style="font-size:.78rem">
                            Maintenance</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Check Availability Banner -->
        <div class="card-box mb-4">
            <h6 class="fw-semibold mb-3"
                style="color:var(--primary)">
                <i class="bi bi-search me-2"></i>
                Check Room Availability
            </h6>
            <div class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label class="form-label fw-semibold">
                        Room Type
                    </label>
                    <select id="av_type" class="form-select">
                        <option value="">All Types</option>
                        <option>Single</option>
                        <option>Double</option>
                        <option>Deluxe</option>
                        <option>Suite</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-semibold">
                        Check-in Date <span class="text-danger">*</span>
                    </label>
                    <input type="date" id="av_cin"
                           class="form-control">
                    <div class="invalid-feedback">Required.</div>
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-semibold">
                        Check-out Date <span class="text-danger">*</span>
                    </label>
                    <input type="date" id="av_cout"
                           class="form-control">
                    <div class="invalid-feedback">
                        Must be after check-in.
                    </div>
                </div>
                <div class="col-md-3">
                    <button type="button"
                            class="btn btn-hotel w-100"
                            onclick="checkAvailability()">
                        <i class="bi bi-search me-1"></i>
                        Check Availability
                    </button>
                </div>
            </div>
            <div id="availResult" class="mt-3"></div>
        </div>

        <!-- All Rooms Table -->
        <div class="card-box">

            <!-- Header -->
            <div class="d-flex flex-wrap align-items-center
                  justify-content-between gap-2 mb-3">
                <h6 class="mb-0"
                    style="color:var(--primary);font-weight:600">
                    <i class="bi bi-grid me-2"></i>All Rooms
                </h6>
                <div class="d-flex gap-2 flex-wrap" id="roomHeaderBtns">
                    <!-- View Toggle -->
                    <div class="view-toggle btn-group">
                        <button type="button"
                                class="btn btn-sm btn-outline-secondary active"
                                id="btnTableView"
                                onclick="setView('table')">
                            <i class="bi bi-list-ul"></i>
                        </button>
                        <button type="button"
                                class="btn btn-sm btn-outline-secondary"
                                id="btnGridView"
                                onclick="setView('grid')">
                            <i class="bi bi-grid"></i>
                        </button>
                    </div>
                    <button type="button"
                            class="btn btn-outline-secondary btn-sm"
                            onclick="loadRooms()">
                        <i class="bi bi-arrow-clockwise me-1"></i>
                        Refresh
                    </button>
                </div>
            </div>

            <!-- Filters -->
            <div class="row g-2 mb-3">
                <div class="col-md-4">
                    <div class="input-group input-group-sm">
            <span class="input-group-text bg-white">
              <i class="bi bi-search text-muted"></i>
            </span>
                        <input type="text" id="searchInput"
                               class="form-control"
                               placeholder="Search room number…"
                               oninput="doFilter()">
                    </div>
                </div>
                <div class="col-md-3">
                    <select id="typeFilter"
                            class="form-select form-select-sm"
                            onchange="doFilter()">
                        <option value="">All Types</option>
                        <option value="Single">Single</option>
                        <option value="Double">Double</option>
                        <option value="Deluxe">Deluxe</option>
                        <option value="Suite">Suite</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select id="statusFilter"
                            class="form-select form-select-sm"
                            onchange="doFilter()">
                        <option value="">All Statuses</option>
                        <option value="AVAILABLE">Available</option>
                        <option value="OCCUPIED">Occupied</option>
                        <option value="MAINTENANCE">Maintenance</option>
                    </select>
                </div>
            </div>

            <!-- Room Display -->
            <div id="roomWrap">
                <div class="text-center py-5 text-muted">
                    <div class="spinner-border text-primary mb-2"></div>
                    <p class="mb-0">Loading rooms…</p>
                </div>
            </div>

            <div class="d-flex justify-content-between mt-2"
                 style="font-size:.8rem;color:#999">
                <span id="tblInfo"></span>
                <span id="tblFilter"></span>
            </div>

        </div>
    </div>
</div>

<!-- ══════════ UPDATE STATUS MODAL ══════════ -->
<div class="modal fade" id="statusModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-pencil me-2"></i>
                    Update Room Status
                </h5>
                <button type="button" class="btn-close"
                        data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted mb-3" style="font-size:.875rem">
                    Room: <strong id="upd_room"></strong>
                    &nbsp;|&nbsp;
                    Type: <strong id="upd_type"></strong>
                </p>
                <div class="mb-3">
                    <label class="form-label fw-semibold">
                        New Status
                    </label>
                    <select id="upd_status" class="form-select">
                        <option value="AVAILABLE">Available</option>
                        <option value="OCCUPIED">Occupied</option>
                        <option value="MAINTENANCE">Maintenance</option>
                    </select>
                </div>
                <div id="updErr"
                     class="alert alert-danger d-none py-2"
                     style="font-size:.85rem"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary"
                        data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-hotel"
                        onclick="submitStatus()">
                    <i class="bi bi-check-circle me-1"></i>
                    Update Status
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ══════════ VIEW ROOM MODAL ══════════ -->
<div class="modal fade" id="viewModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-door-open me-2"></i>
                    Room Details
                </h5>
                <button type="button" class="btn-close"
                        data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="viewBody"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary"
                        data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- ══════════ ADD ROOM MODAL ══════════ -->
<div class="modal fade" id="addRoomModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-plus-circle me-2"></i>Add New Room
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label fw-semibold">
                        Room Number <span class="text-danger">*</span>
                    </label>
                    <input type="text" id="add_roomNumber" class="form-control"
                           placeholder="e.g. 101">
                </div>
                <div class="mb-3">
                    <label class="form-label fw-semibold">
                        Floor Number <span class="text-danger">*</span>
                    </label>
                    <input type="number" id="add_floor" class="form-control"
                           min="1" max="50" placeholder="1 – 50">
                </div>
                <div class="mb-3">
                    <label class="form-label fw-semibold">Room Type</label>
                    <select id="add_type" class="form-select">
                        <option value="Single">Single</option>
                        <option value="Double">Double</option>
                        <option value="Deluxe">Deluxe</option>
                        <option value="Suite">Suite</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-semibold">Status</label>
                    <select id="add_status" class="form-select">
                        <option value="AVAILABLE">Available</option>
                        <option value="OCCUPIED">Occupied</option>
                        <option value="MAINTENANCE">Maintenance</option>
                    </select>
                </div>
                <div id="addRoomErr" class="alert alert-danger d-none py-2"
                     style="font-size:.85rem"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary"
                        data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-hotel"
                        id="addRoomSaveBtn" onclick="submitAddRoom()">
                    <i class="bi bi-plus-lg me-1"></i>Add Room
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ══════════ EDIT ROOM MODAL ══════════ -->
<div class="modal fade" id="editRoomModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-pencil-square me-2"></i>Edit Room
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label fw-semibold">
                        Room Number <span class="text-danger">*</span>
                    </label>
                    <input type="text" id="edit_roomNumber" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label fw-semibold">
                        Floor Number <span class="text-danger">*</span>
                    </label>
                    <input type="number" id="edit_floor" class="form-control"
                           min="1" max="50">
                </div>
                <div class="mb-3">
                    <label class="form-label fw-semibold">Room Type</label>
                    <select id="edit_type" class="form-select">
                        <option value="Single">Single</option>
                        <option value="Double">Double</option>
                        <option value="Deluxe">Deluxe</option>
                        <option value="Suite">Suite</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-semibold">Status</label>
                    <select id="edit_status" class="form-select">
                        <option value="AVAILABLE">Available</option>
                        <option value="OCCUPIED">Occupied</option>
                        <option value="MAINTENANCE">Maintenance</option>
                    </select>
                </div>
                <div id="editRoomErr" class="alert alert-danger d-none py-2"
                     style="font-size:.85rem"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary"
                        data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-hotel"
                        id="editRoomSaveBtn" onclick="submitEditRoom()">
                    <i class="bi bi-check-circle me-1"></i>Update Room
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ══════════ DELETE ROOM MODAL ══════════ -->
<div class="modal fade" id="deleteRoomModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content">
            <div class="modal-header" style="background:#dc3545">
                <h5 class="modal-title text-white">
                    <i class="bi bi-exclamation-triangle me-2"></i>Delete Room
                </h5>
                <button type="button" class="btn-close btn-close-white"
                        data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center py-4">
                <i class="bi bi-trash3 text-danger"
                   style="font-size:2.5rem"></i>
                <p class="mt-3 mb-1 fw-semibold">Delete Room
                    <span id="del_roomLabel" class="text-danger"></span>?
                </p>
                <p class="text-muted mb-0" style="font-size:.85rem">
                    This action cannot be undone.
                </p>
                <div id="deleteRoomErr" class="alert alert-danger d-none py-2 mt-3"
                     style="font-size:.85rem"></div>
            </div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-secondary"
                        data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger"
                        id="deleteRoomConfirmBtn" onclick="submitDeleteRoom()">
                    <i class="bi bi-trash me-1"></i>Delete
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="js/app.js"></script>
<script>
    'use strict';

    var allRooms  = [];
    var actRoomId = 0;
    var viewMode  = 'table'; // 'table' or 'grid'

    // ── Get modal instance ────────────────────────────────────────
    function getModal(id){
        return bootstrap.Modal.getOrCreateInstance(
            document.getElementById(id));
    }

    // ── Init ──────────────────────────────────────────────────────
    document.addEventListener('DOMContentLoaded', function(){
        initPage('rooms.html');

        var today = new Date().toISOString().split('T')[0];
        document.getElementById('av_cin').min  = today;
        document.getElementById('av_cout').min = today;

        // Date change listener
        document.getElementById('av_cin')
            .addEventListener('change', function(){
                var cin = this.value;
                if (cin){
                    var next = new Date(cin);
                    next.setDate(next.getDate() + 1);
                    document.getElementById('av_cout').min =
                        next.toISOString().split('T')[0];
                }
                document.getElementById('availResult').innerHTML = '';
            });

        // Inject Add Room button for admins
        if (Auth.isAdmin()) {
            var addBtn = document.createElement('button');
            addBtn.type = 'button';
            addBtn.className = 'btn btn-hotel btn-sm';
            addBtn.innerHTML = '<i class="bi bi-plus-lg me-1"></i>Add Room';
            addBtn.onclick = openAddRoom;
            var wrap = document.getElementById('roomHeaderBtns');
            wrap.insertBefore(addBtn, wrap.firstChild);
        }

        loadRooms();
    });

    // ══════════════════════════════════════════════
    //  LOAD ROOMS
    // ══════════════════════════════════════════════
    async function loadRooms(){
        document.getElementById('roomWrap').innerHTML =
            '<div class="text-center py-5 text-muted">' +
            '<div class="spinner-border text-primary mb-2"></div>' +
            '<p class="mb-0">Loading rooms…</p></div>';

        try {
            var data = await API.get('api/rooms');
            if (data === null) return;
            allRooms = Array.isArray(data) ? data : [];
            updateStats(allRooms);
            renderRooms(allRooms);
        } catch(err){
            document.getElementById('roomWrap').innerHTML =
                '<div class="text-center py-5 text-danger">' +
                '<i class="bi bi-exclamation-triangle"' +
                ' style="font-size:2.5rem"></i>' +
                '<p class="mt-2 fw-semibold">Failed to load rooms</p>' +
                '<p class="text-muted" style="font-size:.85rem">' +
                err.message + '</p>' +
                '<button type="button"' +
                ' class="btn btn-outline-primary btn-sm mt-1"' +
                ' onclick="loadRooms()">' +
                '<i class="bi bi-arrow-clockwise me-1"></i>' +
                'Retry</button></div>';
        }
    }

    // ── Stats ─────────────────────────────────────────────────────
    function updateStats(list){
        document.getElementById('st-total').textContent =
            list.length;
        document.getElementById('st-available').textContent =
            list.filter(function(r){
                return r.roomStatus==='AVAILABLE';}).length;
        document.getElementById('st-occupied').textContent =
            list.filter(function(r){
                return r.roomStatus==='OCCUPIED';}).length;
        document.getElementById('st-maintenance').textContent =
            list.filter(function(r){
                return r.roomStatus==='MAINTENANCE';}).length;
    }

    // ── View toggle ───────────────────────────────────────────────
    function setView(mode){
        viewMode = mode;
        document.getElementById('btnTableView')
            .classList.toggle('active', mode==='table');
        document.getElementById('btnGridView')
            .classList.toggle('active', mode==='grid');
        renderRooms(getCurrentList());
    }

    function getCurrentList(){
        var q  = document.getElementById('searchInput').value
            .toLowerCase();
        var tp = document.getElementById('typeFilter').value;
        var st = document.getElementById('statusFilter').value;
        return allRooms.filter(function(r){
            var mq = !q ||
                (r.roomNumber||'').toLowerCase().includes(q);
            var mt = !tp || (r.typeName||'')=== tp;
            var ms = !st || r.roomStatus === st;
            return mq && mt && ms;
        });
    }

    // ── Filter ────────────────────────────────────────────────────
    function doFilter(){
        var list = getCurrentList();
        renderRooms(list);
        document.getElementById('tblFilter').textContent =
            list.length !== allRooms.length
                ? list.length + ' matched' : '';
    }

    // ── Render (Table or Grid) ────────────────────────────────────
    function renderRooms(list){
        if (!list.length){
            document.getElementById('roomWrap').innerHTML =
                '<div class="text-center py-5 text-muted">' +
                '<i class="bi bi-door-closed"' +
                ' style="font-size:3rem;opacity:.25"></i>' +
                '<p class="mt-2 mb-0">No rooms found</p></div>';
            document.getElementById('tblInfo').textContent = '';
            return;
        }

        if (viewMode === 'grid'){
            renderGrid(list);
        } else {
            renderTable(list);
        }

        document.getElementById('tblInfo').textContent =
            'Showing ' + list.length + ' of ' +
            allRooms.length + ' rooms';
    }

    // ── Table View ────────────────────────────────────────────────
    function renderTable(list){
        var isAdmin = Auth.role() === 'admin';
        var rows = list.map(function(r){
            var cfg = roomTypeConfig(r.typeName || 'Single');
            return '<tr>' +
                '<td>' +
                '<div class="d-flex align-items-center gap-2">' +
                '<div class="room-thumb" style="background:' + cfg.bgLight + ';color:' + cfg.color + '">' +
                '<i class="bi ' + cfg.icon + '"></i>' +
                '</div>' +
                '<span class="fw-bold" style="font-size:.95rem">' +
                r.roomNumber + '</span>' +
                '</div>' +
                '</td>' +
                '<td>' + floorLabel(r.floorNumber) + '</td>' +
                '<td>' + typeTag(r.typeName)  + '</td>' +
                '<td>' + statusBadge(r.roomStatus) + '</td>' +
                '<td>' +
                '<div class="d-flex gap-1">' +
                '<button type="button"' +
                ' class="btn btn-sm btn-outline-primary"' +
                ' title="View" onclick="viewRoom(' +
                r.roomId + ')">' +
                '<i class="bi bi-eye"></i></button>' +
                (isAdmin
                    ? '<button type="button"' +
                    ' class="btn btn-sm btn-outline-warning"' +
                    ' title="Edit Room"' +
                    ' onclick="openEditRoom(' + r.roomId + ')">' +
                    '<i class="bi bi-pencil"></i></button>' +
                    '<button type="button"' +
                    ' class="btn btn-sm btn-outline-danger"' +
                    ' title="Delete Room"' +
                    ' onclick="openDeleteRoom(' + r.roomId +
                    ',\'' + r.roomNumber + '\')">' +
                    '<i class="bi bi-trash"></i></button>'
                    : (r.roomStatus !== 'AVAILABLE'
                        ? '<button type="button"' +
                        ' class="btn btn-sm btn-outline-success"' +
                        ' title="Mark Available"' +
                        ' onclick="markAvailable(' + r.roomId +
                        ',\'' + r.roomNumber + '\')">' +
                        '<i class="bi bi-check-circle"></i></button>'
                        : '')) +
                '</div>' +
                '</td></tr>';
        }).join('');

        document.getElementById('roomWrap').innerHTML =
            '<div class="table-responsive">' +
            '<table class="table table-hover mb-0">' +
            '<thead><tr>' +
            '<th>Room No</th><th>Floor</th><th>Type</th>' +
            '<th>Status</th>' +
            '<th style="width:100px">Actions</th>' +
            '</tr></thead>' +
            '<tbody>' + rows + '</tbody>' +
            '</table></div>';
    }

    // ── Grid View ─────────────────────────────────────────────────
    function renderGrid(list){
        var isAdmin = Auth.role() === 'admin';
        var cards = list.map(/**
         * Generates an HTML string representing a room card with details and action buttons.
         *
         * @param {Object} r - The room object containing properties for rendering the room card.
         * @param {string} r.roomStatus - The current status of the room (e.g., 'AVAILABLE', 'OCCUPIED').
         * @param {string} r.typeName - The type of the room (e.g., 'Single', 'Suite'). Defaults to 'Single' if not provided.
         * @param {number} r.roomId - The unique identifier for the room.
         * @param {string} r.roomNumber - The number assigned to the room.
         * @param {number} r.floorNumber - The floor number where the room is located.
         * @returns {string} - The composed HTML string for the room card.
         */
        function(r){
            var sc  = statusColor(r.roomStatus);
            var typ = r.typeName || 'Single';
            var cfg = roomTypeConfig(typ);
            return '<div class="col-sm-6 col-lg-4 col-xl-3">' +
                '<div class="room-grid-card">' +

                // Status indicator strip (runs full height, on top of banner)
                '<div style="position:absolute;top:0;left:0;' +
                'width:4px;height:100%;background:' +
                sc + ';border-radius:12px 0 0 12px;z-index:1"></div>' +

                // Room type image banner
                '<div class="room-type-banner" style="' + bannerBg(cfg) + ';color:' + bannerTextColor(cfg) + '">' +
                bannerOverlay(cfg) +
                '<i class="bi ' + cfg.icon + ' rtb-icon"></i>' +
                '<span class="rtb-label">' + cfg.label + '</span>' +
                '<span class="rtb-status" style="color:' + sc + '">' +
                r.roomStatus + '</span>' +
                '</div>' +

                '<div class="ps-2">' +
                '<div class="d-flex justify-content-between' +
                ' align-items-start mb-2">' +
                '<div class="room-number-badge">' +
                r.roomNumber + '</div>' +
                '<span class="room-type-tag ' + typ + '">' +
                typ + '</span>' +
                '</div>' +

                '<div class="mb-2">' +
                '<small class="text-muted">' +
                '<i class="bi bi-layers me-1"></i>' +
                floorLabel(r.floorNumber) +
                '</small>' +
                '</div>' +

                '<div class="d-flex justify-content-between' +
                ' align-items-center mt-3">' +
                '<div>' +
                '<span class="status-dot"' +
                ' style="background:' + sc + '"></span>' +
                '<span style="font-size:.8rem;font-weight:600;' +
                'color:' + sc + '">' +
                r.roomStatus + '</span>' +
                '</div>' +
                '<div class="d-flex gap-1">' +
                '<button type="button"' +
                ' class="btn btn-sm btn-outline-primary"' +
                ' onclick="viewRoom(' + r.roomId + ')">' +
                '<i class="bi bi-eye"></i></button>' +
                (isAdmin
                    ? '<button type="button"' +
                    ' class="btn btn-sm btn-outline-warning"' +
                    ' title="Edit Room"' +
                    ' onclick="openEditRoom(' + r.roomId + ')">' +
                    '<i class="bi bi-pencil"></i></button>' +
                    '<button type="button"' +
                    ' class="btn btn-sm btn-outline-danger"' +
                    ' title="Delete Room"' +
                    ' onclick="openDeleteRoom(' + r.roomId +
                    ',\'' + r.roomNumber + '\')">' +
                    '<i class="bi bi-trash"></i></button>'
                    : (r.roomStatus !== 'AVAILABLE'
                        ? '<button type="button"' +
                        ' class="btn btn-sm btn-outline-success"' +
                        ' title="Mark Available"' +
                        ' onclick="markAvailable(' + r.roomId +
                        ',\'' + r.roomNumber + '\')">' +
                        '<i class="bi bi-check-circle"></i></button>'
                        : '')) +
                '</div>' +
                '</div>' +
                '</div>' +

                '</div>' +
                '</div>';
        }).join('');

        document.getElementById('roomWrap').innerHTML =
            '<div class="row g-3">' + cards + '</div>';
    }

    // ══════════════════════════════════════════════
    //  VIEW ROOM DETAILS
    // ══════════════════════════════════════════════
    function viewRoom(roomId){
        var room = allRooms.find(function(r){
            return r.roomId === roomId;
        });
        if (!room){
            Toast.show('Room not found','warning'); return;
        }

        var cfg = roomTypeConfig(room.typeName || 'Single');
        var sc  = statusColor(room.roomStatus);
        document.getElementById('viewBody').innerHTML =
            // Room type image banner
            '<div style="height:140px;' + bannerBg(cfg) + ';' +
            'display:flex;flex-direction:column;align-items:center;' +
            'justify-content:center;color:' + cfg.color + ';' +
            'border-radius:8px;margin-bottom:1rem;position:relative;overflow:hidden">' +
            '<i class="bi ' + cfg.icon + '" style="font-size:3.5rem;opacity:.85"></i>' +
            '<span style="font-size:.75rem;font-weight:700;letter-spacing:.8px;' +
            'text-transform:uppercase;margin-top:.5rem;opacity:.8">' +
            cfg.label + '</span>' +
            '<span style="position:absolute;top:10px;right:12px;' +
            'font-size:.72rem;font-weight:700;padding:.25rem .65rem;' +
            'border-radius:20px;background:rgba(255,255,255,.85);color:' + sc + '">' +
            room.roomStatus + '</span>' +
            '</div>' +
            '<table class="table table-bordered mb-0"' +
            ' style="font-size:.875rem"><tbody>' +
            vrow('Room Number', room.roomNumber) +
            vrow('Floor',       floorLabel(room.floorNumber)) +
            vrow('Type',        typeTag(room.typeName)) +
            vrow('Status',      statusBadge(room.roomStatus)) +
            '</tbody></table>';

        getModal('viewModal').show();
    }

    // ══════════════════════════════════════════════
    //  UPDATE STATUS (Admin only)
    // ══════════════════════════════════════════════
    function openStatus(id, number, type, currentStatus){
        actRoomId = id;
        document.getElementById('upd_room').textContent   = number;
        document.getElementById('upd_type').textContent   = type;
        document.getElementById('upd_status').value       = currentStatus;
        document.getElementById('updErr').classList.add('d-none');
        getModal('statusModal').show();
    }

    async function submitStatus(){
        document.getElementById('updErr').classList.add('d-none');
        var newStatus = document.getElementById('upd_status').value;
        try {
            var data = await API.put(
                'api/rooms/' + actRoomId + '/status',
                { roomStatus: newStatus }
            );
            if (!data) return;
            getModal('statusModal').hide();
            Toast.show('Room status updated to ' + newStatus,
                'success');
            loadRooms();
        } catch(err){
            var e = document.getElementById('updErr');
            e.textContent = err.message;
            e.classList.remove('d-none');
        }
    }

    // ══════════════════════════════════════════════
    //  MARK AVAILABLE (All staff)
    // ══════════════════════════════════════════════
    async function markAvailable(roomId, roomNumber){
        if (!confirm('Mark Room ' + roomNumber + ' as AVAILABLE?')) return;
        try {
            await API.put(
                'api/rooms/' + roomId + '/status',
                { roomStatus: 'AVAILABLE' }
            );
            Toast.show('Room ' + roomNumber + ' is now Available', 'success');
            loadRooms();
        } catch(err){
            Toast.show(err.message, 'error');
        }
    }

    // ══════════════════════════════════════════════
    //  ADD ROOM (Admin only)
    // ══════════════════════════════════════════════
    function openAddRoom(){
        document.getElementById('add_roomNumber').value = '';
        document.getElementById('add_floor').value      = '';
        document.getElementById('add_type').value       = 'Single';
        document.getElementById('add_status').value     = 'AVAILABLE';
        document.getElementById('addRoomErr').classList.add('d-none');
        getModal('addRoomModal').show();
    }

    async function submitAddRoom(){
        document.getElementById('addRoomErr').classList.add('d-none');
        var roomNumber = document.getElementById('add_roomNumber').value.trim();
        var floor      = parseInt(document.getElementById('add_floor').value);
        var typeName   = document.getElementById('add_type').value;
        var status     = document.getElementById('add_status').value;

        if (!roomNumber){
            showModalErr('addRoomErr','Room number is required.'); return;
        }
        if (!floor || floor < 1 || floor > 50){
            showModalErr('addRoomErr','Floor must be between 1 and 50.'); return;
        }

        var btn = document.getElementById('addRoomSaveBtn');
        btn.disabled = true;
        try {
            await API.post('api/rooms', {
                roomNumber : roomNumber,
                floorNumber: floor,
                typeName   : typeName,
                roomStatus : status
            });
            getModal('addRoomModal').hide();
            Toast.show('Room ' + roomNumber + ' created successfully', 'success');
            loadRooms();
        } catch(err){
            showModalErr('addRoomErr', err.message);
        } finally {
            btn.disabled = false;
        }
    }

    // ══════════════════════════════════════════════
    //  EDIT ROOM (Admin only)
    // ══════════════════════════════════════════════
    var editRoomId = 0;

    function openEditRoom(roomId){
        var room = allRooms.find(function(r){ return r.roomId === roomId; });
        if (!room){ Toast.show('Room not found','warning'); return; }
        editRoomId = roomId;
        document.getElementById('edit_roomNumber').value = room.roomNumber;
        document.getElementById('edit_floor').value      = room.floorNumber;
        document.getElementById('edit_type').value       = room.typeName || 'Single';
        document.getElementById('edit_status').value     = room.roomStatus;
        document.getElementById('editRoomErr').classList.add('d-none');
        getModal('editRoomModal').show();
    }

    async function submitEditRoom(){
        document.getElementById('editRoomErr').classList.add('d-none');
        var roomNumber = document.getElementById('edit_roomNumber').value.trim();
        var floor      = parseInt(document.getElementById('edit_floor').value);
        var typeName   = document.getElementById('edit_type').value;
        var status     = document.getElementById('edit_status').value;

        if (!roomNumber){
            showModalErr('editRoomErr','Room number is required.'); return;
        }
        if (!floor || floor < 1 || floor > 50){
            showModalErr('editRoomErr','Floor must be between 1 and 50.'); return;
        }

        var btn = document.getElementById('editRoomSaveBtn');
        btn.disabled = true;
        try {
            await API.put('api/rooms/' + editRoomId, {
                roomNumber : roomNumber,
                floorNumber: floor,
                typeName   : typeName,
                roomStatus : status
            });
            getModal('editRoomModal').hide();
            Toast.show('Room ' + roomNumber + ' updated successfully', 'success');
            loadRooms();
        } catch(err){
            showModalErr('editRoomErr', err.message);
        } finally {
            btn.disabled = false;
        }
    }

    // ══════════════════════════════════════════════
    //  DELETE ROOM (Admin only)
    // ══════════════════════════════════════════════
    var deleteRoomId = 0;

    function openDeleteRoom(roomId, roomNumber){
        deleteRoomId = roomId;
        document.getElementById('del_roomLabel').textContent = roomNumber;
        document.getElementById('deleteRoomErr').classList.add('d-none');
        getModal('deleteRoomModal').show();
    }

    async function submitDeleteRoom(){
        document.getElementById('deleteRoomErr').classList.add('d-none');
        var btn = document.getElementById('deleteRoomConfirmBtn');
        btn.disabled = true;
        try {
            await API.delete('api/rooms/' + deleteRoomId);
            getModal('deleteRoomModal').hide();
            Toast.show('Room deleted successfully', 'success');
            loadRooms();
        } catch(err){
            showModalErr('deleteRoomErr', err.message);
        } finally {
            btn.disabled = false;
        }
    }

    function showModalErr(id, msg){
        var el = document.getElementById(id);
        el.textContent = msg;
        el.classList.remove('d-none');
    }

    // ══════════════════════════════════════════════
    //  CHECK AVAILABILITY
    // ══════════════════════════════════════════════
    async function checkAvailability(){
        var type = document.getElementById('av_type').value;
        var cin  = document.getElementById('av_cin').value;
        var cout = document.getElementById('av_cout').value;
        var ok   = true;

        if (!cin){
            document.getElementById('av_cin')
                .classList.add('is-invalid');
            ok = false;
        } else {
            document.getElementById('av_cin')
                .classList.remove('is-invalid');
        }
        if (!cout || cout <= cin){
            document.getElementById('av_cout')
                .classList.add('is-invalid');
            ok = false;
        } else {
            document.getElementById('av_cout')
                .classList.remove('is-invalid');
        }
        if (!ok) return;

        var res = document.getElementById('availResult');
        res.innerHTML =
            '<div class="text-center py-3 text-muted">' +
            '<div class="spinner-border spinner-border-sm' +
            ' text-primary me-2"></div>' +
            'Checking availability…</div>';

        try {
            var url = 'api/rooms/available' +
                '?checkin='  + cin +
                '&checkout=' + cout;
            if (type) url += '&type=' + encodeURIComponent(type);

            var rooms = await API.get(url);
            if (rooms === null) return;

            var nights = calcNights(cin, cout);

            if (!rooms.length){
                res.innerHTML =
                    '<div class="alert alert-warning mb-0">' +
                    '<i class="bi bi-exclamation-triangle me-2"></i>' +
                    'No rooms available for selected dates' +
                    (type ? ' and type <strong>' + type + '</strong>' : '') +
                    '. Try different dates.' +
                    '</div>';
                return;
            }

            // Group by type
            var grouped = {};
            rooms.forEach(function(r){
                var t = r.typeName || 'Room';
                if (!grouped[t]) grouped[t] = [];
                grouped[t].push(r);
            });

            var html =
                '<div class="alert alert-success py-2 mb-3"' +
                ' style="font-size:.875rem">' +
                '<i class="bi bi-check-circle me-2"></i>' +
                '<strong>' + rooms.length + ' room(s)</strong> available' +
                ' for <strong>' + nights + ' night' +
                (nights!==1?'s':'') + '</strong>' +
                ' (' + fmtDate(cin) + ' → ' + fmtDate(cout) + ')' +
                '</div>';

            Object.keys(grouped).forEach(function(t){
                html += '<div class="mb-3">' +
                    '<div class="fw-semibold mb-2"' +
                    ' style="font-size:.875rem;color:var(--primary)">' +
                    typeTag(t) + ' <span class="ms-1 text-muted">' +
                    grouped[t].length + ' available</span></div>' +
                    '<div class="row g-2">';
                var tcfg = roomTypeConfig(t);
                grouped[t].forEach(function(r){
                    html +=
                        '<div class="col-md-4 col-sm-6">' +
                        '<div class="avail-card">' +
                        '<div class="avail-banner" style="' + bannerBg(tcfg) + ';color:' + tcfg.color + ';overflow:hidden">' +
                        '<i class="bi ' + tcfg.icon + '"></i>' +
                        '</div>' +
                        '<div class="avail-body">' +
                        '<div class="fw-semibold" style="font-size:.875rem">' +
                        'Room ' + r.roomNumber + '</div>' +
                        '<small class="text-muted">' +
                        '<i class="bi bi-layers me-1"></i>' +
                        floorLabel(r.floorNumber) +
                        '</small>' +
                        '</div>' +
                        '</div></div>';
                });
                html += '</div></div>';
            });

            res.innerHTML = html;

        } catch(err){
            res.innerHTML =
                '<div class="alert alert-danger mb-0">' +
                '<i class="bi bi-exclamation-triangle me-2"></i>' +
                err.message + '</div>';
        }
    }

    // ══════════════════════════════════════════════
    //  HELPERS
    // ══════════════════════════════════════════════

    // Room type visual config — gradient, icon, color, optional photo
    function roomTypeConfig(type){
        var map = {
            Single: {
                bg     : 'linear-gradient(135deg,#e3f2fd,#90caf9)',
                bgLight: '#e3f2fd',
                color  : '#1565c0',
                icon   : 'bi-house-door-fill',
                label  : 'Single Room'
            },
            Double: {
                bg     : 'linear-gradient(135deg,#e8f5e9,#81c784)',
                bgLight: '#e8f5e9',
                color  : '#2e7d32',
                icon   : 'bi-houses-fill',
                label  : 'Double Room'
            },
            Deluxe: {
                bg     : 'linear-gradient(135deg,#fff3e0,#ffb74d)',
                bgLight: '#fff3e0',
                color  : '#e65100',
                icon   : 'bi-stars',
                label  : 'Deluxe Room',
                image  : 'images/rooms/deluxe-room.jpg'
            },
            Suite: {
                bg     : 'linear-gradient(135deg,#f3e5f5,#ba68c8)',
                bgLight: '#f3e5f5',
                color  : '#6a1b9a',
                icon   : 'bi-gem',
                label  : 'Luxury Suite'
            }
        };
        return map[type] || map.Single;
    }

    // Returns the CSS background string for a banner
    function bannerBg(cfg){
        if (cfg.image)
            return 'background-color:' + cfg.bgLight + ';' +
                   'background-image:url("' + cfg.image + '");' +
                   'background-size:cover;background-position:center';
        return 'background:' + cfg.bg;
    }

    // No overlay — photo shows clean
    function bannerOverlay(cfg){ return ''; }

    // Always use the type color (readable on both gradient and photo)
    function bannerTextColor(cfg){ return cfg.color; }

    function floorLabel(f){
        if (!f && f !== 0) return '—';
        var s = ['th','st','nd','rd'];
        var v = f % 100;
        return f + (s[(v-20)%10] || s[v] || s[0]) + ' Floor';
    }

    function typeTag(type){
        var colors = {
            Single  : 'background:#e3f2fd;color:#1565c0',
            Double  : 'background:#e8f5e9;color:#2e7d32',
            Deluxe  : 'background:#fff3e0;color:#e65100',
            Suite   : 'background:#f3e5f5;color:#6a1b9a'
        };
        var style = colors[type] || 'background:#f0f0f0;color:#555';
        return '<span class="badge rounded-pill"' +
            ' style="' + style + ';font-size:.75rem">' +
            (type||'—') + '</span>';
    }

    function statusColor(status){
        var map = {
            AVAILABLE  : '#198754',
            OCCUPIED   : '#e65100',
            MAINTENANCE: '#dc3545'
        };
        return map[status] || '#888';
    }

    function calcNights(cin, cout){
        if (!cin || !cout) return 0;
        return Math.max(0,
            Math.floor((new Date(cout)-new Date(cin))/86400000));
    }

    function vrow(label, value){
        return '<tr>' +
            '<td style="font-weight:500;color:#555;width:38%">' +
            label + '</td>' +
            '<td>' + (value||'—') + '</td>' +
            '</tr>';
    }

</script>
</body>
</html>