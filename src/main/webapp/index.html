<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Login — Hotel System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <style>
        body {
            min-height:100vh; display:flex;
            align-items:center; justify-content:center;
            background:linear-gradient(135deg,#1a3c5e,#2e6da4);
            font-family:'Segoe UI',sans-serif;
        }
        .card {
            width:100%; max-width:400px;
            border:none; border-radius:16px;
            box-shadow:0 20px 60px rgba(0,0,0,.3);
        }
        .logo {
            width:72px; height:72px;
            background:linear-gradient(135deg,#1a3c5e,#2e6da4);
            border-radius:50%; display:flex;
            align-items:center; justify-content:center;
            margin:0 auto .75rem; font-size:2rem; color:#fff;
        }
        .btn-hotel {
            background:linear-gradient(135deg,#1a3c5e,#2e6da4);
            border:none; color:#fff; font-weight:500;
        }
        .btn-hotel:hover { opacity:.9; color:#fff; }
        .btn-hotel:disabled { opacity:.65; }
        .form-control:focus {
            border-color:#2e6da4;
            box-shadow:0 0 0 .2rem rgba(46,109,164,.2);
        }
    </style>
</head>
<body>
<div class="card p-4">
    <div class="logo"><i class="bi bi-building"></i></div>
    <h5 class="text-center fw-bold text-dark mb-1">Hotel Reservation</h5>
    <p class="text-center text-muted mb-4" style="font-size:.875rem">
        Management System
    </p>

    <div id="alertBox" class="alert alert-danger d-none py-2"
         style="font-size:.85rem"></div>
    <div id="attemptBox" class="alert alert-warning d-none py-2 text-center"
         style="font-size:.82rem"></div>

    <div class="mb-3">
        <label class="form-label fw-semibold">Username</label>
        <input id="username" type="text" class="form-control"
               placeholder="Enter username">
        <div class="invalid-feedback">Min 3 characters.</div>
    </div>
    <div class="mb-4">
        <label class="form-label fw-semibold">Password</label>
        <div class="input-group">
            <input id="password" type="password" class="form-control"
                   placeholder="Enter password">
            <button type="button" class="btn btn-outline-secondary"
                    id="togglePass">
                <i class="bi bi-eye" id="eyeIcon"></i>
            </button>
        </div>
        <div class="invalid-feedback">Min 6 characters.</div>
    </div>

    <button type="button" id="loginBtn"
            class="btn btn-hotel w-100 py-2"
            onclick="doLogin()">
    <span id="btnText">
      <i class="bi bi-box-arrow-in-right me-1"></i>Login
    </span>
        <span id="btnSpin" class="d-none">
      <span class="spinner-border spinner-border-sm me-1"></span>
      Signing in…
    </span>
    </button>

    <p class="text-center text-muted mt-3 mb-0"
       style="font-size:.78rem">
        <i class="bi bi-shield-check me-1"></i>
        Authorized personnel only
    </p>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Already logged in → go to dashboard
    if (sessionStorage.getItem('token')) {
        window.location.href = 'dashboard.html';
    }

    var attempts = 0;

    // Toggle password
    document.getElementById('togglePass').addEventListener('click', function(){
        var inp = document.getElementById('password');
        var ico = document.getElementById('eyeIcon');
        inp.type = inp.type === 'password' ? 'text' : 'password';
        ico.className = inp.type === 'password'
            ? 'bi bi-eye' : 'bi bi-eye-slash';
    });

    // Press Enter to login
    document.getElementById('password')
        .addEventListener('keydown', function(e){
            if (e.key === 'Enter') doLogin();
        });
    document.getElementById('username')
        .addEventListener('keydown', function(e){
            if (e.key === 'Enter') doLogin();
        });

    async function doLogin(){
        if (attempts >= 3){
            show('Account locked. Refresh the page to try again.'); return;
        }

        hideAlert();

        var username = document.getElementById('username').value.trim();
        var password = document.getElementById('password').value;
        var ok = true;

        if (username.length < 3){
            document.getElementById('username').classList.add('is-invalid');
            ok = false;
        } else {
            document.getElementById('username').classList.remove('is-invalid');
        }
        if (password.length < 6){
            document.getElementById('password').classList.add('is-invalid');
            ok = false;
        } else {
            document.getElementById('password').classList.remove('is-invalid');
        }
        if (!ok) return;

        setLoad(true);

        try {
            var resp = await fetch(
                window.location.origin + '/api/auth/login', {
                    method : 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body   : JSON.stringify({
                        username: username,
                        password: password
                    })
                }
            );

            var data;
            try { data = await resp.json(); }
            catch(e){
                show('Server error. Check Tomcat console.'); return;
            }

            if (resp.ok && data.token) {
                sessionStorage.setItem('token',    data.token);
                sessionStorage.setItem('role',     data.role);
                sessionStorage.setItem('userName', data.fullName);   // app.js uses 'userName'
                sessionStorage.setItem('staffId',  String(data.staffId));
                window.location.href = 'dashboard.html';
            } else {
                attempts++;
                var left = 3 - attempts;
                show(data.error || 'Invalid username or password');
                if (left > 0){
                    var abox = document.getElementById('attemptBox');
                    abox.textContent = left + ' attempt' +
                        (left > 1 ? 's' : '') + ' remaining';
                    abox.classList.remove('d-none');
                } else {
                    document.getElementById('loginBtn').disabled = true;
                    show('Account locked. Refresh to try again.');
                }
                document.getElementById('password').value = '';
            }

        } catch(err){
            show('Cannot reach server. Is Tomcat running?');
        } finally {
            setLoad(false);
        }
    }

    function show(msg){
        var b = document.getElementById('alertBox');
        b.textContent = msg;
        b.classList.remove('d-none');
    }
    function hideAlert(){
        document.getElementById('alertBox').classList.add('d-none');
        document.getElementById('attemptBox').classList.add('d-none');
    }
    function setLoad(on){
        document.getElementById('btnText').classList.toggle('d-none', on);
        document.getElementById('btnSpin').classList.toggle('d-none', !on);
        document.getElementById('loginBtn').disabled = on;
    }
</script>
</body>
</html>