<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Login — Hotel Reservation System</title>
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
</head>
<body>

<div class="login-wrapper">
    <div class="login-card">

        <!-- Logo -->
        <div class="login-logo">
            <i class="bi bi-building"></i>
        </div>
        <h4 class="login-title">Hotel Reservation</h4>
        <p class="login-subtitle mb-4">Management System</p>

        <!-- Alert -->
        <div id="alertBox" class="alert alert-danger d-none" role="alert">
            <i class="bi bi-exclamation-triangle me-2"></i>
            <span id="alertMsg"></span>
        </div>

        <!-- Attempt Warning -->
        <div id="attemptBox" class="attempt-badge d-none mb-3">
            <i class="bi bi-shield-exclamation me-1"></i>
            <span id="attemptMsg"></span>
        </div>

        <!-- Login Form -->
        <form id="loginForm" novalidate>

            <!-- Username -->
            <div class="mb-3">
                <label class="form-label" for="username">
                    <i class="bi bi-person me-1"></i>Username
                </label>
                <input type="text"
                       id="username"
                       class="form-control"
                       placeholder="Enter your username"
                       autocomplete="username"
                       required
                       minlength="3"
                       maxlength="50">
                <div class="invalid-feedback">
                    Username must be at least 3 characters.
                </div>
            </div>

            <!-- Password -->
            <div class="mb-4">
                <label class="form-label" for="password">
                    <i class="bi bi-lock me-1"></i>Password
                </label>
                <div class="input-group">
                    <input type="password"
                           id="password"
                           class="form-control"
                           placeholder="Enter your password"
                           autocomplete="current-password"
                           required
                           minlength="6">
                    <button class="btn btn-outline-secondary"
                            type="button"
                            id="togglePass"
                            tabindex="-1">
                        <i class="bi bi-eye" id="eyeIcon"></i>
                    </button>
                </div>
                <div class="invalid-feedback">
                    Password must be at least 6 characters.
                </div>
            </div>

            <!-- Submit -->
            <button type="submit"
                    id="loginBtn"
                    class="btn btn-hotel w-100 py-2">
        <span id="btnText">
          <i class="bi bi-box-arrow-in-right me-1"></i>Login
        </span>
                <span id="btnSpinner" class="d-none">
          <span class="spinner-border spinner-border-sm me-1"></span>
          Signing in...
        </span>
            </button>

        </form>

        <p class="text-center mt-3 mb-0" style="font-size:0.8rem;color:#999">
            <i class="bi bi-shield-check me-1"></i>
            Secured access — authorized personnel only
        </p>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="js/app.js"></script>
<script>
    // Redirect if already logged in
    if (localStorage.getItem('token')) {
        window.location.href = 'dashboard.html';
    }

    let attempts = 0;
    const MAX_ATTEMPTS = 3;

    // Toggle password visibility
    document.getElementById('togglePass').addEventListener('click', () => {
        const input   = document.getElementById('password');
        const icon    = document.getElementById('eyeIcon');
        const isPass  = input.type === 'password';
        input.type    = isPass ? 'text' : 'password';
        icon.className = isPass ? 'bi bi-eye-slash' : 'bi bi-eye';
    });

    // Form submission
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        hideAlert();

        // Check lockout
        if (attempts >= MAX_ATTEMPTS) {
            showAlert('Account locked after 3 failed attempts. Please refresh the page.');
            return;
        }

        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value;

        // Client-side validation
        let valid = true;

        if (username.length < 3) {
            document.getElementById('username').classList.add('is-invalid');
            valid = false;
        } else {
            document.getElementById('username').classList.remove('is-invalid');
        }

        if (password.length < 6) {
            document.getElementById('password').classList.add('is-invalid');
            valid = false;
        } else {
            document.getElementById('password').classList.remove('is-invalid');
        }

        if (!valid) return;

        // Show loading
        setLoading(true);

        try {
            const data = await API.post('/api/auth/login', { username, password });

            // Save session
            localStorage.setItem('token',    data.token);
            localStorage.setItem('role',     data.role);
            localStorage.setItem('fullName', data.fullName);
            localStorage.setItem('staffId',  data.staffId);

            // Redirect to dashboard
            window.location.href = 'dashboard.html';

        } catch (err) {
            attempts++;
            const remaining = MAX_ATTEMPTS - attempts;

            if (remaining <= 0) {
                showAlert('Account locked. Too many failed attempts. Please refresh.');
                document.getElementById('loginBtn').disabled = true;
            } else {
                showAlert(err.message || 'Invalid credentials');
                document.getElementById('attemptBox').classList.remove('d-none');
                document.getElementById('attemptMsg').textContent =
                    `${remaining} attempt${remaining > 1 ? 's' : ''} remaining`;
            }
        } finally {
            setLoading(false);
        }
    });

    function showAlert(msg) {
        document.getElementById('alertMsg').textContent = msg;
        document.getElementById('alertBox').classList.remove('d-none');
    }

    function hideAlert() {
        document.getElementById('alertBox').classList.add('d-none');
        document.getElementById('attemptBox').classList.add('d-none');
    }

    function setLoading(on) {
        document.getElementById('btnText').classList.toggle('d-none', on);
        document.getElementById('btnSpinner').classList.toggle('d-none', !on);
        document.getElementById('loginBtn').disabled = on;
    }
</script>
</body>
</html>